(()=>{"use strict";var e={766:function(e,t,o){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(o(252)),i=s(o(577)),a=o(252),d=s(o(718)),r=s(o(898)),u=(0,n.default)();u.use((0,i.default)()),u.use((0,a.json)()),u.use((0,r.default)()),u.use("/api/v1",d.default),t.default=u},257:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(n,i){function a(e){try{r(s.next(e))}catch(e){i(e)}}function d(e){try{r(s.throw(e))}catch(e){i(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,d)}r((s=s.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(o(252)),a=n(o(818)),d=o(376),r=n(o(829));a.default.config();const u=i.default.Router();u.route("/").get(((e,t)=>s(void 0,void 0,void 0,(function*(){var o;try{console.log("GET CHATS");const s=null===(o=null==e?void 0:e.query)||void 0===o?void 0:o.user_id;if(!s)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});const n=r.default.sign({sub:s,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),i=(0,d.createClient)({req:e,res:t},n),{data:a,error:u}=yield i.from("chat").select().eq("user_id",s);if(u)return t.status(500),void t.send({ok:!1,data:[],message:u.message});t.status(200),t.send({ok:!0,data:a,message:"success"})}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),u.route("/").post(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s,n,i;try{console.log("POST CHAT");let a=(null===(o=null==e?void 0:e.body)||void 0===o?void 0:o.title)||"New Chat";const u=null===(s=null==e?void 0:e.body)||void 0===s?void 0:s.user_id,l=null===(n=null==e?void 0:e.body)||void 0===n?void 0:n.created_at,c=null===(i=null==e?void 0:e.body)||void 0===i?void 0:i.chat_id;if(!u)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});if(!c)return t.status(400),void t.send({ok:!1,data:[],message:"Invalid Request"});const v=r.default.sign({sub:u,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),g=(0,d.createClient)({req:e,res:t},v),{data:m,error:f}=yield g.from("chat").select().eq("user_id",u).like("title",`%${a}%`);if(f)return t.status(500),void t.send({ok:!1,data:[],message:f.message});m&&m.length>1&&(a+=` ${m.length}`);const{data:h,error:_}=yield g.from("chat").upsert({id:c,created_at:l,user_id:u,title:a}).select().single();return _?(t.status(500),void t.send({ok:!1,data:[],message:_.message})):(t.status(200),void t.send({ok:!0,data:h,message:"success"}))}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),u.route("/:id").get(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s;try{console.log("GET CHAT");const n=null===(o=null==e?void 0:e.query)||void 0===o?void 0:o.user_id,i=null===(s=null==e?void 0:e.params)||void 0===s?void 0:s.id;if(!n)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});const a=r.default.sign({sub:n,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),u=(0,d.createClient)({req:e,res:t},a),{data:l,error:c}=yield u.from("chat").select().eq("user_id",n).eq("id",i).single();if(c)return t.status(500),void t.send({ok:!1,data:[],message:c.message});t.status(200),t.send({ok:!0,data:l,message:"success"})}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),u.route("/:id").patch(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s,n;try{console.log("PATCH CHAT");const i=null===(o=null==e?void 0:e.body)||void 0===o?void 0:o.title,a=null===(s=null==e?void 0:e.params)||void 0===s?void 0:s.id,u=null===(n=null==e?void 0:e.body)||void 0===n?void 0:n.user_id;if(!i)return t.status(400),void t.send({ok:!1,data:[],message:"Invalid Request"});if(!u)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});const l=r.default.sign({sub:u,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),c=(0,d.createClient)({req:e,res:t},l),{data:v,error:g}=yield c.from("chat").update({title:i}).eq("id",a).select().single();if(g)return t.status(500),void t.send({ok:!1,data:[],message:g.message});t.status(200),t.send({ok:!0,data:v,message:"success"})}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),u.route("/:id").delete(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s;try{console.log("DELETE CHAT");const n=null===(o=null==e?void 0:e.params)||void 0===o?void 0:o.id,i=null===(s=null==e?void 0:e.query)||void 0===s?void 0:s.user_id;if(!i)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});const a=r.default.sign({sub:i,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),u=(0,d.createClient)({req:e,res:t},a),{error:l}=yield u.from("chat").delete().eq("id",n).eq("user_id",i).single();return l?(t.status(500),void t.send({ok:!1,data:[],message:l.message})):(t.status(200),void t.send({ok:!0,data:[],message:"success"}))}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),t.default=u},827:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(n,i){function a(e){try{r(s.next(e))}catch(e){i(e)}}function d(e){try{r(s.throw(e))}catch(e){i(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,d)}r((s=s.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(356),a=n(o(252));n(o(818)).default.config();const d=a.default.Router(),r=new i.ChromaClient({path:process.env.CHROMADB_URL});d.route("/").get(((e,t)=>s(void 0,void 0,void 0,(function*(){const e=yield r.listCollections();e&&e.length>0&&t.send(e)})))),t.default=d},237:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(n,i){function a(e){try{r(s.next(e))}catch(e){i(e)}}function d(e){try{r(s.throw(e))}catch(e){i(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,d)}r((s=s.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(o(252)),a=n(o(818)),d=n(o(938)),r=o(376),u=n(o(829));a.default.config();const l=i.default.Router();l.route("/").get(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s;try{console.log("GET COMPLETIONS");const n=null===(o=null==e?void 0:e.query)||void 0===o?void 0:o.user_id,i=null===(s=null==e?void 0:e.query)||void 0===s?void 0:s.chat_id;if(!n)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});if(!i)return t.status(400),void t.send({ok:!1,data:[],message:"No Chat Input Provided"});const a=u.default.sign({sub:n,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),d=(0,r.createClient)({req:e,res:t},a),{data:l,error:c}=yield d.from("chat_completion").select().eq("user_id",n).eq("chat_id",i).order("created",{ascending:!0});if(c)return console.log(c),t.status(500),void t.send({ok:!1,data:[],message:c.message});t.status(200),t.send({ok:!0,data:l,message:"success"})}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),l.route("/").post(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s,n,i;try{console.log("POST COMPLETION");const a=null===(o=null==e?void 0:e.body)||void 0===o?void 0:o.user_input,l=(null===(s=null==e?void 0:e.body)||void 0===s?void 0:s.messages)||[],c=null===(n=null==e?void 0:e.body)||void 0===n?void 0:n.user_id,v=null===(i=null==e?void 0:e.body)||void 0===i?void 0:i.chat_id;if(!a)return t.status(400),void t.send({ok:!1,data:[],message:"No User Input Provided"});if(!c)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});if(!v)return t.status(400),void t.send({ok:!1,data:[],message:"Invalid Request"});const g=u.default.sign({sub:c,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),m=(0,r.createClient)({req:e,res:t},g),f=yield d.default.post("https://api.openai.com/v1/chat/completions",{model:"gpt-3.5-turbo",messages:[...l,{role:"system",content:"You are a helpful assistant"},{role:"user",content:a}]},{headers:{Authorization:`Bearer ${process.env.OPENAI_API_KEY}`}});if("OK"!==f.statusText)return console.log(f.statusText),t.status(500),void t.send({ok:!1,data:[],message:f.statusText});{const e=f.data,{data:o,error:s}=yield m.from("chat_completion").upsert({id:e.id,object:e.object,created:e.created,model:e.model,role:e.choices[0].message.role,message:e.choices[0].message.content,finish_reason:e.choices[0].finish_reason,prompt_tokens:e.usage.prompt_tokens,completion_tokens:e.usage.completion_tokens,total_tokens:e.usage.total_tokens,user_id:c,chat_id:v,prompt:a}).select().single();if(s)return console.log(s),t.status(500),void t.send({ok:!1,data:[],message:s.message});t.status(200),t.send({ok:!0,data:o,message:"success"})}}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),l.route("/:id").get(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s,n;try{console.log("GET COMPLETION");const i=null===(o=null==e?void 0:e.query)||void 0===o?void 0:o.user_id,a=null===(s=null==e?void 0:e.query)||void 0===s?void 0:s.chat_id,d=null===(n=null==e?void 0:e.params)||void 0===n?void 0:n.id;if(!i)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});if(!a)return t.status(400),void t.send({ok:!1,data:[],message:"No Chat Input Provided"});const l=u.default.sign({sub:i,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),c=(0,r.createClient)({req:e,res:t},l),{data:v,error:g}=yield c.from("chat_completion").select().eq("user_id",i).eq("chat_id",a).eq("id",d).single();if(g)return console.log(g),t.status(500),void t.send({ok:!1,data:[],message:g.message});t.status(200),t.send({ok:!0,data:v,message:"success"})}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),t.default=l},732:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(n,i){function a(e){try{r(s.next(e))}catch(e){i(e)}}function d(e){try{r(s.throw(e))}catch(e){i(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,d)}r((s=s.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(o(252)),a=n(o(818)),d=o(376),r=n(o(829));a.default.config();const u=i.default.Router();u.route("/").get(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s,n;try{console.log("GET FEEDBACK");const i=null===(o=null==e?void 0:e.query)||void 0===o?void 0:o.user_id,a=null===(s=null==e?void 0:e.query)||void 0===s?void 0:s.completion_id,u=null===(n=null==e?void 0:e.query)||void 0===n?void 0:n.chat_id;if(!i)return t.status(400),void t.send({ok:!1,data:void 0,message:"Authentication Error"});if(!a)return t.status(400),void t.send({ok:!1,data:void 0,message:"No Completions ID provided"});if(!u)return t.status(400),void t.send({ok:!1,data:void 0,message:"Invalid Request"});const l=r.default.sign({sub:i,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),c=(0,d.createClient)({req:e,res:t},l),{data:v,error:g}=yield c.from("completion_feedback").select().eq("user_id",i).eq("completion_id",a).eq("chat_id",u);if(g)throw new Error(g.message);return t.status(200),void t.send({ok:!0,data:v,message:"success"})}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),u.route("/").post(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s,n,i,a,u,l;try{console.log("POST FEEDBACK");const c=null===(o=null==e?void 0:e.body)||void 0===o?void 0:o.user_id,v=null===(s=null==e?void 0:e.body)||void 0===s?void 0:s.completion_id,g=null===(n=null==e?void 0:e.body)||void 0===n?void 0:n.chat_id,m=null===(i=null==e?void 0:e.body)||void 0===i?void 0:i.rating_id,f=null===(a=null==e?void 0:e.body)||void 0===a?void 0:a.rating,h=null===(u=null==e?void 0:e.body)||void 0===u?void 0:u.prompt,_=null===(l=null==e?void 0:e.body)||void 0===l?void 0:l.completion;if(!g)return t.status(400),void t.send({ok:!1,data:[],message:"Invalid Request"});if(!c)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});if(!m)return t.status(400),void t.send({ok:!1,data:[],message:"No Rating ID provided"});if(!f)return t.status(400),void t.send({ok:!1,data:[],message:"No Rating provided"});if(!v)return t.status(400),void t.send({ok:!1,data:[],message:"No Completion ID provided"});if(!_)return t.status(400),void t.send({ok:!1,data:[],message:"No Completion provided"});if(!h)return t.status(400),void t.send({ok:!1,data:[],message:"No Prompt provided"});const p=r.default.sign({sub:c,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),y=(0,d.createClient)({req:e,res:t},p),{data:k,error:E}=yield y.from("completion_feedback").upsert([{user_id:c,id:m,chat_id:g,completion_id:v,created_at:(new Date).toISOString(),rating:f,prompt:h,completion:_}]).select().single();if(k)return t.status(200),void t.send({ok:!0,data:k,message:"success"});if(E)throw new Error(E.message)}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),u.route("/").delete(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s,n;try{console.log("DELETE FEEDBACK");const i=null===(o=null==e?void 0:e.query)||void 0===o?void 0:o.user_id,a=null===(s=null==e?void 0:e.query)||void 0===s?void 0:s.completion_id,u=null===(n=null==e?void 0:e.query)||void 0===n?void 0:n.chat_id;if(!i)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});if(!a)return t.status(400),void t.send({ok:!1,data:[],message:"No Completions ID provided"});if(!u)return t.status(400),void t.send({ok:!1,data:[],message:"Invalid Request"});const l=r.default.sign({sub:i,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),c=(0,d.createClient)({req:e,res:t},l),{error:v}=yield c.from("completion_feedback").delete().eq("user_id",i).eq("completion_id",a).eq("chat_id",u).single();if(!v)return t.status(200),void t.send({ok:!0,data:[],message:"success"});if(v)throw new Error(v.message)}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),t.default=u},12:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(n,i){function a(e){try{r(s.next(e))}catch(e){i(e)}}function d(e){try{r(s.throw(e))}catch(e){i(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,d)}r((s=s.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(o(252)),a=n(o(818)),d=o(376),r=n(o(829));a.default.config();const u=i.default.Router();u.route("/").get(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s;try{console.log("GET HIGGINS CHATS");const n=null===(o=null==e?void 0:e.query)||void 0===o?void 0:o.user_id,i=null===(s=null==e?void 0:e.query)||void 0===s?void 0:s.organization;if(!n)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});if(!i)return t.status(400),void t.send({ok:!1,data:[],message:"No Organization provided"});const a=r.default.sign({sub:n,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),u=(0,d.createClient)({req:e,res:t},a),{data:l,error:c}=yield u.from("higgins_chat").select().eq("user_id",n).eq("organization",i).order("created_at",{ascending:!0});if(c)return t.status(500),void t.send({ok:!1,data:[],message:c.message});t.status(200),t.send({ok:!0,data:l,message:"success"})}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),u.route("/").post(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s,n,i,a;try{console.log("POST HIGGINS CHAT");let u=(null===(o=null==e?void 0:e.body)||void 0===o?void 0:o.title)||"New Chat";const l=null===(s=null==e?void 0:e.body)||void 0===s?void 0:s.user_id,c=null===(n=null==e?void 0:e.body)||void 0===n?void 0:n.created_at,v=null===(i=null==e?void 0:e.body)||void 0===i?void 0:i.chat_id,g=null===(a=null==e?void 0:e.body)||void 0===a?void 0:a.organization;if(!l)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});if(!v)return t.status(400),void t.send({ok:!1,data:[],message:"Invalid Request"});if(!g)return t.status(400),void t.send({ok:!1,data:[],message:"No Organization provided"});const m=r.default.sign({sub:l,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),f=(0,d.createClient)({req:e,res:t},m),{data:h,error:_}=yield f.from("higgins_chat").select().eq("user_id",l).eq("organization",g).like("title",`%${u}%`);if(_)return t.status(500),void t.send({ok:!1,data:[],message:_.message});h&&h.length>1&&(u+=` ${h.length}`);const{data:p,error:y}=yield f.from("higgins_chat").upsert({id:v,created_at:c,user_id:l,organization:g,title:u}).select().single();return y?(t.status(500),void t.send({ok:!1,data:[],message:y.message})):(t.status(200),void t.send({ok:!0,data:p,message:"success"}))}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),u.route("/:id").get(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s;try{console.log("GET HIGGINS CHAT");const n=null===(o=null==e?void 0:e.query)||void 0===o?void 0:o.user_id,i=null===(s=null==e?void 0:e.params)||void 0===s?void 0:s.id;if(!n)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});const a=r.default.sign({sub:n,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),u=(0,d.createClient)({req:e,res:t},a),{data:l,error:c}=yield u.from("higgins_chat").select().eq("user_id",n).eq("id",i).single();if(c)return t.status(500),void t.send({ok:!1,data:[],message:c.message});t.status(200),t.send({ok:!0,data:l,message:"success"})}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),u.route("/:id").patch(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s;try{console.log("PATCH HIGGINS CHAT");const n=null===(o=null==e?void 0:e.body)||void 0===o?void 0:o.title,i=null===(s=null==e?void 0:e.params)||void 0===s?void 0:s.id,a=null==e?void 0:e.body.user_id;if(!n)return t.status(400),void t.send({ok:!1,data:[],message:"Invalid Request"});if(!a)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});const u=r.default.sign({sub:a,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),l=(0,d.createClient)({req:e,res:t},u),{data:c,error:v}=yield l.from("higgins_chat").update({title:n}).eq("id",i).select().single();if(v)return t.status(500),void t.send({ok:!1,data:[],message:v.message});t.status(200),t.send({ok:!0,data:c,message:"success"})}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),u.route("/:id").delete(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s;try{console.log("DELETE HIGGINS CHAT");const n=null===(o=null==e?void 0:e.params)||void 0===o?void 0:o.id,i=null===(s=null==e?void 0:e.query)||void 0===s?void 0:s.user_id;if(!i)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});const a=r.default.sign({sub:i,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),u=(0,d.createClient)({req:e,res:t},a),{error:l}=yield u.from("higgins_chat").delete().eq("id",n).eq("user_id",i).single();return l?(console.log(t),t.status(500),void t.send({ok:!1,data:[],message:l.message})):(t.status(200),void t.send({ok:!0,data:[],message:"success"}))}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),t.default=u},228:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(n,i){function a(e){try{r(s.next(e))}catch(e){i(e)}}function d(e){try{r(s.throw(e))}catch(e){i(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,d)}r((s=s.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(356),a=n(o(252)),d=n(o(818)),r=n(o(938)),u=o(376),l=n(o(829));d.default.config();const c=a.default.Router(),v=new i.ChromaClient({path:process.env.CHROMADB_URL}),g=new i.OpenAIEmbeddingFunction({openai_api_key:process.env.OPENAI_API_KEY});c.route("/").get(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s;try{console.log("GET HIGGINS COMPLETIONS");const n=null===(o=null==e?void 0:e.query)||void 0===o?void 0:o.user_id,i=null===(s=null==e?void 0:e.query)||void 0===s?void 0:s.chat_id;if(!n)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});if(!i)return t.status(400),void t.send({ok:!1,data:[],message:"No Chat Input Provided"});const a=l.default.sign({sub:n,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),d=(0,u.createClient)({req:e,res:t},a),{data:r,error:c}=yield d.from("higgins_chat_completion").select().eq("user_id",n).eq("chat_id",i).order("created",{ascending:!0});if(c)return console.log(c),t.status(500),void t.send({ok:!1,data:[],message:c.message});t.status(200),t.send({ok:!0,data:r,message:"success"})}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),c.route("/").post(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,n,i,a,d,c,m,f;try{console.log("POST HIGGINS COMPLETION");const h=null===(o=null==e?void 0:e.body)||void 0===o?void 0:o.system_directive,_=null===(n=null==e?void 0:e.body)||void 0===n?void 0:n.user_input,p=(null===(i=null==e?void 0:e.body)||void 0===i?void 0:i.messages)||[],y=null===(a=null==e?void 0:e.body)||void 0===a?void 0:a.user_id,k=null===(d=null==e?void 0:e.body)||void 0===d?void 0:d.chat_id,E=null===(c=null==e?void 0:e.body)||void 0===c?void 0:c.chat_id,S=null===(m=null==e?void 0:e.body)||void 0===m?void 0:m.organization;if(!_)return t.status(400),void t.send({ok:!1,data:[],message:"No User Input Provided"});if(!y)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});if(!k)return t.status(400),void t.send({ok:!1,data:[],message:"Invalid Request"});if(!S)return t.status(400),void t.send({ok:!1,data:[],message:"No Organization Provided"});const q=l.default.sign({sub:y,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),A=(0,u.createClient)({req:e,res:t},q),b=yield((e,t)=>s(void 0,void 0,void 0,(function*(){const o=yield v.getCollection({name:t,embeddingFunction:g}),s=yield o.query({queryTexts:e,nResults:5});if(s.documents)return s.documents})))(_,S),C=null===(f=null==b?void 0:b.at(0))||void 0===f?void 0:f.map((e=>null==e?void 0:e.replace("\n"," "))),T=`Your name is Higgins. You are a helpful assistant for the company ${S}. I will provide you some supporting documents that you can use to help you respond to the user's next prompt. If the supporting documents do not closely relate to the user's prompt, ignore them as you formulate a response. If the user's prompt refers to any previous messages, ignore the supporting documents as you formulate a response. The following text is the supporting documents: ${C}`,w=yield r.default.post("https://api.openai.com/v1/chat/completions",{model:"gpt-3.5-turbo-16k",messages:[...p,{role:"system",content:h?h+C:T},{role:"user",content:_}],temperature:E?Number(E):.7},{headers:{Authorization:`Bearer ${process.env.OPENAI_API_KEY}`}});if("OK"!==w.statusText)return console.log(w.statusText),t.status(500),void t.send({ok:!1,data:[],message:w.statusText});{const e=w.data,{data:o,error:s}=yield A.from("higgins_chat_completion").insert({id:e.id,object:e.object,created:e.created,model:e.model,role:e.choices[0].message.role,message:e.choices[0].message.content,finish_reason:e.choices[0].finish_reason,prompt_tokens:e.usage.prompt_tokens,completion_tokens:e.usage.completion_tokens,total_tokens:e.usage.total_tokens,user_id:y,chat_id:k,prompt:_,documents:C}).select().single();if(s)return console.log(s),t.status(500),void t.send({ok:!1,data:[],message:s.message});t.status(200),t.send({ok:!0,data:o,message:"success"})}}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),c.route("/:id").get(((e,t)=>s(void 0,void 0,void 0,(function*(){var o,s,n;try{const i=null===(o=null==e?void 0:e.query)||void 0===o?void 0:o.user_id,a=null===(s=null==e?void 0:e.params)||void 0===s?void 0:s.id,d=null===(n=null==e?void 0:e.params)||void 0===n?void 0:n.id;if(!i)return t.status(400),void t.send({ok:!1,data:[],message:"Authentication Error"});if(!a)return t.status(400),void t.send({ok:!1,data:[],message:"No Chat Input Provided"});const r=l.default.sign({sub:i,role:"authenticated"},process.env.SUPABASE_JWT_SECRET),c=(0,u.createClient)({req:e,res:t},r),{data:v,error:g}=yield c.from("higgins_chat_completion").select().eq("user_id",i).eq("chat_id",a).eq("id",d).single();if(g)return console.log(g),t.status(500),void t.send({ok:!1,data:[],message:g.message});t.status(200),t.send({ok:!0,data:v,message:"success"})}catch(e){return console.log(e),t.status(500),void t.send({ok:!1,data:[],message:"Something went wrong"})}})))),t.default=c},718:function(e,t,o){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(o(252)),i=s(o(237)),a=s(o(827)),d=s(o(257)),r=s(o(12)),u=s(o(228)),l=s(o(732)),c=n.default.Router();c.get("/status",((e,t)=>t.send("OK"))),c.use("/completion",i.default),c.use("/collection",a.default),c.use("/chat",d.default),c.use("/higgins-chat",r.default),c.use("/higgins-completion",u.default),c.use("/feedback",l.default),t.default=c},376:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createClient=void 0;const s=o(405);t.createClient=(e,t)=>(0,s.createServerClient)(process.env.SUPABASE_URL,process.env.SUPABASE_ANON_KEY,{global:{headers:{Authorization:t?`Bearer ${t}`:""}},cookies:{get:t=>{var o;if(!t)return;const s=null!==(o=e.req.cookies[t])&&void 0!==o?o:"";return s?decodeURIComponent(s):void 0},set:(t,o,s)=>{e.res&&e.res.cookie(t,encodeURIComponent(o),Object.assign(Object.assign({},s),{sameSite:"Lax",httpOnly:!0}))},remove:(t,o)=>{e.res&&e.res.cookie(t,"",Object.assign(Object.assign({},o),{httpOnly:!0}))}}})},156:function(e,t,o){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(o(766)),i=process.env.PORT||4e3;n.default.listen(i,(()=>console.log("Listening on port "+i)))},405:e=>{e.exports=require("@supabase/ssr")},938:e=>{e.exports=require("axios")},356:e=>{e.exports=require("chromadb")},898:e=>{e.exports=require("cookie-parser")},577:e=>{e.exports=require("cors")},818:e=>{e.exports=require("dotenv")},252:e=>{e.exports=require("express")},829:e=>{e.exports=require("jsonwebtoken")}},t={};!function o(s){var n=t[s];if(void 0!==n)return n.exports;var i=t[s]={exports:{}};return e[s].call(i.exports,i,i.exports,o),i.exports}(156)})();
//# sourceMappingURL=bundle.js.map